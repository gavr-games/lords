var MooTools={version:"1.2.5",build:"008d8f0f2fcc2044e54fdd3635341aaab274e757"};
function Native(a){a=a||{};var b=a.name,c=a.legacy,d=a.protect,e=a.implement,f=a.generics,g=a.initialize,l=a.afterImplement||function(){};a=g||c;f=f!==false;a.constructor=Native;a.$family={name:"native"};if(c&&g)a.prototype=c.prototype;a.prototype.constructor=a;if(b){b=b.toLowerCase();a.prototype.$family={name:b};Native.typize(a,b)}function j(h,i,k,m){if(!d||m||!h.prototype[i])h.prototype[i]=k;f&&Native.genericize(h,i,d);l.call(h,i,k);return h}a.alias=function(h,i,k){if(typeof h=="string")if(h=h=
this.prototype[h])return j(this,i,h,k);for(var m in h)this.alias(m,h[m],i);return this};a.implement=function(h,i,k){if(typeof h=="string")return j(this,h,i,k);for(var m in h)j(this,m,h[m],i);return this};e&&a.implement(e);return a}Native.genericize=function(a,b,c){if((!c||!a[b])&&typeof a.prototype[b]=="function")a[b]=function(){var d=Array.prototype.slice.call(arguments);return a.prototype[b].apply(d.shift(),d)}};Native.implement=function(a,b){for(var c=0,d=a.length;c<d;c++)a[c].implement(b)};
Native.typize=function(a,b){if(!a.type)a.type=function(c){return $type(c)===b}};
(function(){var a={Array:Array,Date:Date,Function:Function,Number:Number,RegExp:RegExp,String:String};for(var b in a)new Native({name:b,initialize:a[b],protect:true});b={"boolean":Boolean,"native":Native,object:Object};for(var c in b)Native.typize(b[c],c);c={Array:["concat","indexOf","join","lastIndexOf","pop","push","reverse","shift","slice","sort","splice","toString","unshift","valueOf"],String:["charAt","charCodeAt","concat","indexOf","lastIndexOf","match","replace","search","slice","split","substr",
"substring","toLowerCase","toUpperCase","valueOf"]};for(var d in c)for(b=c[d].length;b--;)Native.genericize(a[d],c[d][b],true)})();var Hash=new Native({name:"Hash",initialize:function(a){if($type(a)=="hash")a=$unlink(a.getClean());for(var b in a)this[b]=a[b];return this}});
Hash.implement({forEach:function(a,b){for(var c in this)this.hasOwnProperty(c)&&a.call(b,this[c],c,this)},getClean:function(){var a={};for(var b in this)if(this.hasOwnProperty(b))a[b]=this[b];return a},getLength:function(){var a=0;for(var b in this)this.hasOwnProperty(b)&&a++;return a}});Hash.alias("forEach","each");Array.implement({forEach:function(a,b){for(var c=0,d=this.length;c<d;c++)a.call(b,this[c],c,this)}});Array.alias("forEach","each");
function $A(a){if(a.item){for(var b=a.length,c=new Array(b);b--;)c[b]=a[b];return c}return Array.prototype.slice.call(a)}function $arguments(a){return function(){return arguments[a]}}function $chk(a){return!!(a||a===0)}function $clear(a){clearTimeout(a);clearInterval(a);return null}function $defined(a){return a!=undefined}function $each(a,b,c){var d=$type(a);(d=="arguments"||d=="collection"||d=="array"?Array:Hash).each(a,b,c)}function $empty(){}
function $extend(a,b){for(var c in b||{})a[c]=b[c];return a}function $H(a){return new Hash(a)}function $lambda(a){return $type(a)=="function"?a:function(){return a}}function $merge(){var a=Array.slice(arguments);a.unshift({});return $mixin.apply(null,a)}function $mixin(a){for(var b=1,c=arguments.length;b<c;b++){var d=arguments[b];if($type(d)=="object")for(var e in d){var f=d[e],g=a[e];a[e]=g&&$type(f)=="object"&&$type(g)=="object"?$mixin(g,f):$unlink(f)}}return a}
function $pick(){for(var a=0,b=arguments.length;a<b;a++)if(arguments[a]!=undefined)return arguments[a];return null}function $random(a,b){return Math.floor(Math.random()*(b-a+1)+a)}function $splat(a){var b=$type(a);return b?b!="array"&&b!="arguments"?[a]:a:[]}var $time=Date.now||function(){return+new Date};function $try(){for(var a=0,b=arguments.length;a<b;a++)try{return arguments[a]()}catch(c){}return null}
function $type(a){if(a==undefined)return false;if(a.$family)return a.$family.name=="number"&&!isFinite(a)?false:a.$family.name;if(a.nodeName)switch(a.nodeType){case 1:return"element";case 3:return/\S/.test(a.nodeValue)?"textnode":"whitespace"}else if(typeof a.length=="number")if(a.callee)return"arguments";else if(a.item)return"collection";return typeof a}
function $unlink(a){var b;switch($type(a)){case "object":b={};for(var c in a)b[c]=$unlink(a[c]);break;case "hash":b=new Hash(a);break;case "array":b=[];c=0;for(var d=a.length;c<d;c++)b[c]=$unlink(a[c]);break;default:return a}return b}
var Browser=$merge({Engine:{name:"unknown",version:0},Platform:{name:window.orientation!=undefined?"ipod":(navigator.platform.match(/mac|win|linux/i)||["other"])[0].toLowerCase()},Features:{xpath:!!document.evaluate,air:!!window.runtime,query:!!document.querySelector},Plugins:{},Engines:{presto:function(){return!window.opera?false:arguments.callee.caller?960:document.getElementsByClassName?950:925},trident:function(){return!window.ActiveXObject?false:window.XMLHttpRequest?document.querySelectorAll?
6:5:4},webkit:function(){return navigator.taintEnabled?false:Browser.Features.xpath?Browser.Features.query?525:420:419},gecko:function(){return!document.getBoxObjectFor&&window.mozInnerScreenX==null?false:document.getElementsByClassName?19:18}}},Browser||{});Browser.Platform[Browser.Platform.name]=true;Browser.detect=function(){for(var a in this.Engines){var b=this.Engines[a]();if(b){this.Engine={name:a,version:b};this.Engine[a]=this.Engine[a+b]=true;break}}return{name:a,version:b}};Browser.detect();
Browser.Request=function(){return $try(function(){return new XMLHttpRequest},function(){return new ActiveXObject("MSXML2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")})};Browser.Features.xhr=!!Browser.Request();
Browser.Plugins.Flash=function(){var a=($try(function(){return navigator.plugins["Shockwave Flash"].description},function(){return(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")).GetVariable("$version")})||"0 r0").match(/\d+/g);return{version:parseInt(a[0]||"0."+a[1],10)||0,build:parseInt(a[2],10)||0}}();
function $exec(a){if(!a)return a;if(window.execScript)window.execScript(a);else{var b=document.createElement("script");b.setAttribute("type","text/javascript");b[Browser.Engine.webkit&&Browser.Engine.version<420?"innerText":"text"]=a;document.head.appendChild(b);document.head.removeChild(b)}return a}Native.UID=1;
var $uid=Browser.Engine.trident?function(a){return(a.uid||(a.uid=[Native.UID++]))[0]}:function(a){return a.uid||(a.uid=Native.UID++)},Window=new Native({name:"Window",legacy:Browser.Engine.trident?null:window.Window,initialize:function(a){$uid(a);if(!a.Element){a.Element=$empty;Browser.Engine.webkit&&a.document.createElement("iframe");a.Element.prototype=Browser.Engine.webkit?window["[[DOMElement.prototype]]"]:{}}a.document.window=a;return $extend(a,Window.Prototype)},afterImplement:function(a,b){window[a]=
Window.Prototype[a]=b}});Window.Prototype={$family:{name:"window"}};new Window(window);
var Document=new Native({name:"Document",legacy:Browser.Engine.trident?null:window.Document,initialize:function(a){$uid(a);a.head=a.getElementsByTagName("head")[0];a.html=a.getElementsByTagName("html")[0];Browser.Engine.trident&&Browser.Engine.version<=4&&$try(function(){a.execCommand("BackgroundImageCache",false,true)});Browser.Engine.trident&&a.window.attachEvent("onunload",function(){a.window.detachEvent("onunload",arguments.callee);a.head=a.html=a.window=null});return $extend(a,Document.Prototype)},
afterImplement:function(a,b){document[a]=Document.Prototype[a]=b}});Document.Prototype={$family:{name:"document"}};new Document(document);
Array.implement({every:function(a,b){for(var c=0,d=this.length;c<d;c++)if(!a.call(b,this[c],c,this))return false;return true},filter:function(a,b){for(var c=[],d=0,e=this.length;d<e;d++)a.call(b,this[d],d,this)&&c.push(this[d]);return c},clean:function(){return this.filter($defined)},indexOf:function(a,b){var c=this.length;for(b=b<0?Math.max(0,c+b):b||0;b<c;b++)if(this[b]===a)return b;return-1},map:function(a,b){for(var c=[],d=0,e=this.length;d<e;d++)c[d]=a.call(b,this[d],d,this);return c},some:function(a,
b){for(var c=0,d=this.length;c<d;c++)if(a.call(b,this[c],c,this))return true;return false},associate:function(a){for(var b={},c=Math.min(this.length,a.length),d=0;d<c;d++)b[a[d]]=this[d];return b},link:function(a){for(var b={},c=0,d=this.length;c<d;c++)for(var e in a)if(a[e](this[c])){b[e]=this[c];delete a[e];break}return b},contains:function(a,b){return this.indexOf(a,b)!=-1},extend:function(a){for(var b=0,c=a.length;b<c;b++)this.push(a[b]);return this},getLast:function(){return this.length?this[this.length-
1]:null},getRandom:function(){return this.length?this[$random(0,this.length-1)]:null},include:function(a){this.contains(a)||this.push(a);return this},combine:function(a){for(var b=0,c=a.length;b<c;b++)this.include(a[b]);return this},erase:function(a){for(var b=this.length;b--;)this[b]===a&&this.splice(b,1);return this},empty:function(){this.length=0;return this},flatten:function(){for(var a=[],b=0,c=this.length;b<c;b++){var d=$type(this[b]);if(d)a=a.concat(d=="array"||d=="collection"||d=="arguments"?
Array.flatten(this[b]):this[b])}return a},hexToRgb:function(a){if(this.length!=3)return null;var b=this.map(function(c){if(c.length==1)c+=c;return c.toInt(16)});return a?b:"rgb("+b+")"},rgbToHex:function(a){if(this.length<3)return null;if(this.length==4&&this[3]==0&&!a)return"transparent";for(var b=[],c=0;c<3;c++){var d=(this[c]-0).toString(16);b.push(d.length==1?"0"+d:d)}return a?b:"#"+b.join("")}});try{delete Function.prototype.bind}catch(e$$1){}
Function.implement({extend:function(a){for(var b in a)this[b]=a[b];return this},create:function(a){var b=this;a=a||{};return function(c){var d=a.arguments;d=d!=undefined?$splat(d):Array.slice(arguments,a.event?1:0);if(a.event)d=[c||window.event].extend(d);function e(){return b.apply(a.bind||null,d)}if(a.delay)return setTimeout(e,a.delay);if(a.periodical)return setInterval(e,a.periodical);if(a.attempt)return $try(e);return e()}},run:function(a,b){return this.apply(b,$splat(a))},pass:function(a,b){return this.create({bind:b,
arguments:a})},bind:function(a,b){return this.create({bind:a,arguments:b})},bindWithEvent:function(a,b){return this.create({bind:a,arguments:b,event:true})},attempt:function(a,b){return this.create({bind:b,arguments:a,attempt:true})()},delay:function(a,b,c){return this.create({bind:b,arguments:c,delay:a})()},periodical:function(a,b,c){return this.create({bind:b,arguments:c,periodical:a})()}});
Number.implement({limit:function(a,b){return Math.min(b,Math.max(a,this))},round:function(a){a=Math.pow(10,a||0);return Math.round(this*a)/a},times:function(a,b){for(var c=0;c<this;c++)a.call(b,c,this)},toFloat:function(){return parseFloat(this)},toInt:function(a){return parseInt(this,a||10)}});Number.alias("times","each");
(function(a){var b={};a.each(function(c){Number[c]||(b[c]=function(){return Math[c].apply(null,[this].concat($A(arguments)))})});Number.implement(b)})(["abs","acos","asin","atan","atan2","ceil","cos","exp","floor","log","max","min","pow","sin","sqrt","tan"]);
String.implement({test:function(a,b){return(typeof a=="string"?new RegExp(a,b):a).test(this)},contains:function(a,b){return b?(b+this+b).indexOf(b+a+b)>-1:this.indexOf(a)>-1},trim:function(){return this.replace(/^\s+|\s+$/g,"")},clean:function(){return this.replace(/\s+/g," ").trim()},camelCase:function(){return this.replace(/-\D/g,function(a){return a.charAt(1).toUpperCase()})},hyphenate:function(){return this.replace(/[A-Z]/g,function(a){return"-"+a.charAt(0).toLowerCase()})},capitalize:function(){return this.replace(/\b[a-z]/g,
function(a){return a.toUpperCase()})},escapeRegExp:function(){return this.replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")},toInt:function(a){return parseInt(this,a||10)},toFloat:function(){return parseFloat(this)},hexToRgb:function(a){var b=this.match(/^#?(\w{1,2})(\w{1,2})(\w{1,2})$/);return b?b.slice(1).hexToRgb(a):null},rgbToHex:function(a){var b=this.match(/\d{1,3}/g);return b?b.rgbToHex(a):null},stripScripts:function(a){var b="",c=this.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi,function(d,e){b+=
e+"\n";return""});if(a===true)$exec(b);else $type(a)=="function"&&a(b,c);return c},substitute:function(a,b){return this.replace(b||/\\?\{([^{}]+)\}/g,function(c,d){if(c.charAt(0)=="\\")return c.slice(1);return a[d]!=undefined?a[d]:""})}});
Hash.implement({has:Object.prototype.hasOwnProperty,keyOf:function(a){for(var b in this)if(this.hasOwnProperty(b)&&this[b]===a)return b;return null},hasValue:function(a){return Hash.keyOf(this,a)!==null},extend:function(a){Hash.each(a||{},function(b,c){Hash.set(this,c,b)},this);return this},combine:function(a){Hash.each(a||{},function(b,c){Hash.include(this,c,b)},this);return this},erase:function(a){this.hasOwnProperty(a)&&delete this[a];return this},get:function(a){return this.hasOwnProperty(a)?
this[a]:null},set:function(a,b){if(!this[a]||this.hasOwnProperty(a))this[a]=b;return this},empty:function(){Hash.each(this,function(a,b){delete this[b]},this);return this},include:function(a,b){if(this[a]==undefined)this[a]=b;return this},map:function(a,b){var c=new Hash;Hash.each(this,function(d,e){c.set(e,a.call(b,d,e,this))},this);return c},filter:function(a,b){var c=new Hash;Hash.each(this,function(d,e){a.call(b,d,e,this)&&c.set(e,d)},this);return c},every:function(a,b){for(var c in this)if(this.hasOwnProperty(c)&&
!a.call(b,this[c],c))return false;return true},some:function(a,b){for(var c in this)if(this.hasOwnProperty(c)&&a.call(b,this[c],c))return true;return false},getKeys:function(){var a=[];Hash.each(this,function(b,c){a.push(c)});return a},getValues:function(){var a=[];Hash.each(this,function(b){a.push(b)});return a},toQueryString:function(a){var b=[];Hash.each(this,function(c,d){if(a)d=a+"["+d+"]";switch($type(c)){case "object":d=Hash.toQueryString(c,d);break;case "array":var e={};c.each(function(f,
g){e[g]=f});d=Hash.toQueryString(e,d);break;default:d=d+"="+encodeURIComponent(c)}c!=undefined&&b.push(d)});return b.join("&")}});Hash.alias({keyOf:"indexOf",hasValue:"contains"});
var Event=new Native({name:"Event",initialize:function(a,b){b=b||window;var c=b.document;a=a||b.event;if(a.$extended)return a;this.$extended=true;for(var d=a.type,e=a.target||a.srcElement;e&&e.nodeType==3;)e=e.parentNode;if(d.test(/key/)){var f=a.which||a.keyCode,g=Event.Keys.keyOf(f);if(d=="keydown"){b=f-111;if(b>0&&b<13)g="f"+b}g=g||String.fromCharCode(f).toLowerCase()}else if(d.match(/(click|mouse|menu)/i)){c=!c.compatMode||c.compatMode=="CSS1Compat"?c.html:c.body;var l={x:a.pageX||a.clientX+c.scrollLeft,
y:a.pageY||a.clientY+c.scrollTop},j={x:a.pageX?a.pageX-b.pageXOffset:a.clientX,y:a.pageY?a.pageY-b.pageYOffset:a.clientY};if(d.match(/DOMMouseScroll|mousewheel/))var h=a.wheelDelta?a.wheelDelta/120:-(a.detail||0)/3;var i=a.which==3||a.button==2,k=null;if(d.match(/over|out/)){switch(d){case "mouseover":k=a.relatedTarget||a.fromElement;break;case "mouseout":k=a.relatedTarget||a.toElement}(function(){for(;k&&k.nodeType==3;)k=k.parentNode;return true}).create({attempt:Browser.Engine.gecko})()||(k=false)}}return $extend(this,
{event:a,type:d,page:l,client:j,rightClick:i,wheel:h,relatedTarget:k,target:e,code:f,key:g,shift:a.shiftKey,control:a.ctrlKey,alt:a.altKey,meta:a.metaKey})}});Event.Keys=new Hash({enter:13,up:38,down:40,left:37,right:39,esc:27,space:32,backspace:8,tab:9,"delete":46});
Event.implement({stop:function(){return this.stopPropagation().preventDefault()},stopPropagation:function(){if(this.event.stopPropagation)this.event.stopPropagation();else this.event.cancelBubble=true;return this},preventDefault:function(){if(this.event.preventDefault)this.event.preventDefault();else this.event.returnValue=false;return this}});
function Class(a){if(a instanceof Function)a={initialize:a};var b=function(){Object.reset(this);if(b._prototyping)return this;this._current=$empty;var c=this.initialize?this.initialize.apply(this,arguments):this;delete this._current;delete this.caller;return c}.extend(this);b.implement(a);b.constructor=Class;return b.prototype.constructor=b}Function.prototype.protect=function(){this._protected=true;return this};
Object.reset=function(a,b){if(b==null){for(var c in a)Object.reset(a,c);return a}delete a[b];switch($type(a[b])){case "object":c=function(){};c.prototype=a[b];c=new c;a[b]=Object.reset(c);break;case "array":a[b]=$unlink(a[b]);break}return a};
(new Native({name:"Class",initialize:Class})).extend({instantiate:function(a){a._prototyping=true;var b=new a;delete a._prototyping;return b},wrap:function(a,b,c){if(c._origin)c=c._origin;return function(){if(c._protected&&this._current==null)throw new Error('The method "'+b+'" cannot be called.');var d=this.caller,e=this._current;this.caller=e;this._current=arguments.callee;var f=c.apply(this,arguments);this._current=e;this.caller=d;return f}.extend({_owner:a,_origin:c,_name:b})}});
Class.implement({implement:function(a,b){if($type(a)=="object"){for(var c in a)this.implement(c,a[c]);return this}if(c=Class.Mutators[a]){b=c.call(this,b);if(b==null)return this}c=this.prototype;switch($type(b)){case "function":if(b._hidden)return this;c[a]=Class.wrap(this,a,b);break;case "object":var d=c[a];if($type(d)=="object")$mixin(d,b);else c[a]=$unlink(b);break;case "array":c[a]=$unlink(b);break;default:c[a]=b}return this}});
Class.Mutators={Extends:function(a){this.parent=a;this.prototype=Class.instantiate(a);this.implement("parent",function(){var b=this.caller._name,c=this.caller._owner.parent.prototype[b];if(!c)throw new Error('The method "'+b+'" has no parent.');return c.apply(this,arguments)}.protect())},Implements:function(a){$splat(a).each(function(b){if(b instanceof Function)b=Class.instantiate(b);this.implement(b)},this)}};
var Chain=new Class({$chain:[],chain:function(){this.$chain.extend(Array.flatten(arguments));return this},callChain:function(){return this.$chain.length?this.$chain.shift().apply(this,arguments):false},clearChain:function(){this.$chain.empty();return this}}),Events=new Class({$events:{},addEvent:function(a,b,c){a=Events.removeOn(a);if(b!=$empty){this.$events[a]=this.$events[a]||[];this.$events[a].include(b);if(c)b.internal=true}return this},addEvents:function(a){for(var b in a)this.addEvent(b,a[b]);
return this},fireEvent:function(a,b,c){a=Events.removeOn(a);if(!this.$events||!this.$events[a])return this;this.$events[a].each(function(d){d.create({bind:this,delay:c,arguments:b})()},this);return this},removeEvent:function(a,b){a=Events.removeOn(a);if(!this.$events[a])return this;b.internal||this.$events[a].erase(b);return this},removeEvents:function(a){var b;if($type(a)=="object"){for(b in a)this.removeEvent(b,a[b]);return this}if(a)a=Events.removeOn(a);for(b in this.$events)if(!(a&&a!=b))for(var c=
this.$events[b],d=c.length;d--;)this.removeEvent(b,c[d]);return this}});Events.removeOn=function(a){return a.replace(/^on([A-Z])/,function(b,c){return c.toLowerCase()})};
var Options=new Class({setOptions:function(){this.options=$merge.run([this.options].extend(arguments));if(!this.addEvent)return this;for(var a in this.options)if(!($type(this.options[a])!="function"||!/^on[A-Z]/.test(a))){this.addEvent(a,this.options[a]);delete this.options[a]}return this}}),Cookie=new Class({Implements:Options,options:{path:false,domain:false,duration:false,secure:false,document:document},initialize:function(a,b){this.key=a;this.setOptions(b)},write:function(a){a=encodeURIComponent(a);
if(this.options.domain)a+="; domain="+this.options.domain;if(this.options.path)a+="; path="+this.options.path;if(this.options.duration){var b=new Date;b.setTime(b.getTime()+this.options.duration*24*60*60*1E3);a+="; expires="+b.toGMTString()}if(this.options.secure)a+="; secure";this.options.document.cookie=this.key+"="+a;return this},read:function(){var a=this.options.document.cookie.match("(?:^|;)\\s*"+this.key.escapeRegExp()+"=([^;]*)");return a?decodeURIComponent(a[1]):null},dispose:function(){(new Cookie(this.key,
$merge(this.options,{duration:-1}))).write("");return this}});Cookie.write=function(a,b,c){return(new Cookie(a,c)).write(b)};Cookie.read=function(a){return(new Cookie(a)).read()};Cookie.dispose=function(a,b){return(new Cookie(a,b)).dispose()};
var Request=new Class({Implements:[Chain,Events,Options],options:{url:"",data:"",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/javascript, text/html, application/xml, text/xml, */*"},async:true,format:false,method:"post",link:"ignore",isSuccess:null,emulation:true,urlEncoded:true,encoding:"utf-8",evalScripts:false,evalResponse:false,noCache:false},initialize:function(a){this.xhr=new Browser.Request;this.setOptions(a);this.options.isSuccess=this.options.isSuccess||this.isSuccess;this.headers=
new Hash(this.options.headers)},onStateChange:function(){if(!(this.xhr.readyState!=4||!this.running)){this.running=false;this.status=0;$try(function(){this.status=this.xhr.status}.bind(this));this.xhr.onreadystatechange=$empty;if(this.options.isSuccess.call(this,this.status)){this.response={text:this.xhr.responseText,xml:this.xhr.responseXML};this.success(this.response.text,this.response.xml)}else{this.response={text:null,xml:null};this.failure()}}},isSuccess:function(){return this.status>=200&&this.status<
300},processScripts:function(a){if(this.options.evalResponse||/(ecma|java)script/.test(this.getHeader("Content-type")))return $exec(a);return a.stripScripts(this.options.evalScripts)},success:function(a,b){this.onSuccess(this.processScripts(a),b)},onSuccess:function(){this.fireEvent("complete",arguments).fireEvent("success",arguments).callChain()},failure:function(){this.onFailure()},onFailure:function(){this.fireEvent("complete").fireEvent("failure",this.xhr)},setHeader:function(a,b){this.headers.set(a,
b);return this},getHeader:function(a){return $try(function(){return this.xhr.getResponseHeader(a)}.bind(this))},check:function(){if(!this.running)return true;switch(this.options.link){case "cancel":this.cancel();return true;case "chain":this.chain(this.caller.bind(this,arguments));return false}return false},send:function(a){if(!this.check(a))return this;this.running=true;var b=$type(a);if(b=="string"||b=="element")a={data:a};b=this.options;a=$extend({data:b.data,url:b.url,method:b.method},a);b=a.data;
var c=String(a.url);a=a.method.toLowerCase();switch($type(b)){case "element":b=document.id(b).toQueryString();break;case "object":case "hash":b=Hash.toQueryString(b)}if(this.options.format){var d="format="+this.options.format;b=b?d+"&"+b:d}if(this.options.emulation&&!["get","post"].contains(a)){a="_method="+a;b=b?a+"&"+b:a;a="post"}if(this.options.urlEncoded&&a=="post"){d=this.options.encoding?"; charset="+this.options.encoding:"";this.headers.set("Content-type","application/x-www-form-urlencoded"+
d)}if(this.options.noCache){d="noCache="+(new Date).getTime();b=b?d+"&"+b:d}d=c.lastIndexOf("/");if(d>-1&&(d=c.indexOf("#"))>-1)c=c.substr(0,d);if(b&&a=="get"){c=c+(c.contains("?")?"&":"?")+b;b=null}this.xhr.open(a.toUpperCase(),c,this.options.async);this.xhr.onreadystatechange=this.onStateChange.bind(this);this.headers.each(function(e,f){try{this.xhr.setRequestHeader(f,e)}catch(g){this.fireEvent("exception",[f,e])}},this);this.fireEvent("request");this.xhr.send(b);this.options.async||this.onStateChange();
return this},cancel:function(){if(!this.running)return this;this.running=false;this.xhr.abort();this.xhr.onreadystatechange=$empty;this.xhr=new Browser.Request;this.fireEvent("cancel");return this}});(function(){var a={};["get","post","put","delete","GET","POST","PUT","DELETE"].each(function(b){a[b]=function(){var c=Array.link(arguments,{url:String.type,data:$defined});return this.send($extend(c,{method:b}))}});Request.implement(a)})();var APE={version:"1.0",Request:{},Transport:{}};
APE.Events=new Class({Extends:Events,onRaw:function(a,b,c){return this.addEvent("raw_"+a.toLowerCase(),b,c)},onCmd:function(a,b,c){return this.addEvent("cmd_"+a.toLowerCase(),b,c)},onError:function(a,b,c){return this.addEvent("error_"+a,b,c)},removeEvent:function(a,b){return Events.prototype.removeEvent.run([a,this.$originalEvents[a][b]],this)}});
APE.Core=new Class({Implements:[APE.Events,Options],$originalEvents:{},options:{server:"",pollTime:25E3,identifier:"ape",transport:0,frequency:0,cycledStackTime:350,secure:false},initialize:function(a){window.Ape=this;this.setOptions(a);this.selectTransport();this.request=new APE.Request(this);this.pipes=new $H;this.users=new $H;this.pubid=this.sessid=null;this.serverUri=(this.options.secure?"https":"http")+"://"+this.options.frequency+"."+this.options.server+"/"+this.options.transport+"/?";this.timer=
null;this.failCounter=this.status=0;this.pollerObserver=null;this.requestDisabled=false;this.onRaw("login",this.rawLogin);this.onRaw("err",this.rawErr);this.onRaw("ident",this.rawIdent);this.onRaw("quit",this.rawQuit);this.onError("003",this.clearSession);this.onError("004",this.clearSession);a.init&&a.init.apply(null,[this]);a.complete&&a.complete.apply(null,[this]);this.fireEvent("load",this);this.options.connectOptions&&this.start(this.options.connectOptions)},selectTransport:function(){for(var a=
[APE.Transport.longPolling,APE.Transport.XHRStreaming,APE.Transport.JSONP,null,null,null,APE.Transport.WebSocket],b=this.options.transport,c;c!==true;){c=a[b].browserSupport();if(c===true){this.options.transport=b;this.transport=new a[b](this)}else b=c}},poller:function(){this.pollerActive&&this.check()},startPoller:function(){this.pollerActive=true},stopPoller:function(){$clear(this.pollerObserver);this.pollerActive=false},stopRequest:function(){this.cancelRequest();this.transport.streamRequest&&
this.transport.streamRequest.cancel();this.requestDisabled=true},parseParam:function(a){return $type(a)=="object"?Hash.getValues(a):$splat(a)},cancelRequest:function(){this.transport.cancel()},requestFail:function(a){if(this.status>0){this.status=a;this.cancelRequest();this.stopPoller();this.fireEvent("apeDisconnect")}this.failCounter<6&&this.failCounter++;this.cancelRequest();a=this.failCounter*$random(300,1E3);this.check.delay(a,this)},parseResponse:function(a,b){if(a)if(this.status<0){this.failCounter=
0;this.status=1;this.startPoller();this.fireEvent("apeReconnect")}var c=false;if(a){a=JSON.parse(a);if(!a){this.check();return}for(var d=0;d<a.length;d++){var e=a[d];b&&$type(b)=="function"&&b.run(e);this.callRaw(e);if(this.transport.running())c=false;else if(!e.data.code||e.data.code!="006"&&e.data.code!="007"&&e.data.code!="005"&&e.data.code!="001"&&e.data.code!="004"&&e.data.code!="003")c=true}}else this.transport.running()||(c=true);c&&this.check()},callRaw:function(a){var b;if(a.data.pipe){var c=
a.data.pipe.pubid;if(c=this.pipes.has(c)?this.pipes.get(c):this.newPipe(a.data.pipe.casttype,a.data)){b=[a,c];c.fireEvent("raw_"+a.raw.toLowerCase(),b)}}else b=a;this.fireEvent("onRaw",b);if(a.data.chl)if(c=this.request.callbackChl.get(a.data.chl)){this.request.callbackChl.erase(a.data.chl);c.run(a)}this.fireEvent("raw_"+a.raw.toLowerCase(),b)},newPipe:function(a,b){if(b&&b.pipe.pubid){var c=this.pipes.get(b.pipe.pubid);if(c)return c}if(a=="uni")return new APE.PipeSingle(this,b);if(a=="multi")return new APE.PipeMulti(this,
b);if(a=="proxy")return new APE.PipeProxy(this,b)},getRequest:function(a){return a.request?this.request[a.request].add.bind(this.request[a.request]):this.request.send.bind(this.request)},addPipe:function(a,b){return this.pipes.set(a,b)},getPipe:function(a){var b=this.pipes.get(a);if(!b)if(b=this.users.get(a))b=this.newPipe("uni",{pipe:b});return b},delPipe:function(a){var b=this.pipes.get(a);this.pipes.erase(a);this.fireEvent(b.type+"PipeDelete",[b]);return b},check:function(){this.request.send("CHECK")},
start:function(a,b){this.connect(a,b)},connect:function(a,b){b||(b={});b.sessid=false;this.request.stack.add("CONNECT",a,b);this.options.channel&&this.request.stack.add("JOIN",{channels:this.options.channel},b);!$defined(b.sendStack)&&b.sendStack!==false&&this.request.stack.send()},join:function(a,b){b=b||{};b.channels=a;this.request.send("JOIN",b)},left:function(a){this.request.send("LEFT",{channel:this.pipes.get(a).name})},quit:function(){this.request.send("QUIT");this.clearSession()},getPubid:function(){return this.pubid},
getSessid:function(){return this.sessid},setSession:function(a,b){this.restoring||this.request.send("SESSION",{action:"set",values:a},b)},getSession:function(a,b,c){c||(c={});var d={};if(b)d.callback=function(e){e.raw=="SESSIONS"&&this.apply(null,arguments)}.bind(b);d.requestCallback=c.requestCallback||null;this.getRequest(c)("SESSION",{action:"get",values:$type(a)=="array"?a:[a]},d);c.request&&c.sendStack!==false&&this.request[c.request].send()},rawIdent:function(a){this.user=a.data.user;this.pubid=
a.data.user.pubid;this.user.pipes=new $H;this.users.set(this.pubid,this.user)},rawLogin:function(a){this.sessid=a.data.sessid;this.status=1;this.startPoller();this.fireEvent("ready");this.fireEvent("init")},rawErr:function(a){this.fireEvent("error_"+a.data.code,a)},rawQuit:function(){this.stopRequest()},clearSession:function(){this.pubid=this.sessid=null;this.$events={};this.request.chl=1;this.status=0;this.options.restore=false;this.fireEvent("clearSession");this.stopPoller();this.cancelRequest()}});
var Ape;APE.init=function(a){(function(){new APE.Core(a)}).delay(1)};
APE.Pipe=new Class({Implements:APE.Events,initialize:function(a,b){this.pipe=b.pipe;this.properties=b.pipe.properties;this.ape=a;this.initRequestMethod();this.ape.addPipe(this.pipe.pubid,this)},initRequestMethod:function(){this.request={};this.request={send:function(){var a=this.parsePipeCmd.apply(this,arguments);this.ape.request.send.apply(this.ape.request,a)}.bind(this),cycledStack:{add:function(){var a=this.parsePipeCmd.apply(this,arguments);this.ape.request.cycledStack.add.apply(this.ape.request.cycledStack,
a)}.bind(this),send:this.ape.request.send,setTime:this.ape.request.cycledStack.setTime.bind(this.ape.request.cycledStack)},stack:{add:function(){var a=this.parsePipeCmd.apply(this,arguments);this.ape.request.stack.add.apply(this.ape.request.stack,a)}.bind(this),send:this.ape.request.stack.send.bind(this.ape.request.stack)}}},parsePipeCmd:function(){var a=Array.prototype.slice.call(arguments);if($type(arguments[0])=="array")for(var b=0;b<a[0].length;b++){if(!a[0][b].params)a[0][b].params={};if(this.pipe)a[0][b].pipe=
this.pipe.pubid}else{a[1]||(a[1]={});if(this.pipe)a[1].pipe=this.pipe.pubid}return a},send:function(a){this.request.send("SEND",{msg:a})},getPubid:function(){return this.pipe.pubid},fireGlobalEvent:function(a,b,c){this.fireEvent(a,b,c);this.ape.fireEvent(a,b,c)},fireInTheHall:this.fireGlobalEvent});
APE.PipeProxy=new Class({Extends:APE.Pipe,initialize:function(a,b){this.ape=this.core=a||window.Ape;this.initRequestMethod();this.type="proxy";b&&this.init(b)},init:function(a){this.pipe=a.pipe;this.core.addPipe(this.getPubid(),this);this.onRaw("proxy_event",this.rawProxyEvent);this.ape.fireEvent("proxyPipeCreate",[this,a])},reset:function(){},close:function(){},open:function(a,b){this.core.status==0&&this.core.start(null,false);this.request.stack.add("PROXY_CONNECT",{host:a,port:b},this.pipe?{}:
{callback:this.callback.bind(this)});this.request.stack.send()},send:function(a){this.request.send("SEND",{msg:B64.encode(a)})},rawProxyEvent:function(a){switch(a.data.event){case "read":a=B64.decode(a.data.data);this.fireGlobalEvent("proxyRead",a);this.onread&&this.onread(a);break;case "connect":this.fireGlobalEvent("proxyConnect");this.onopen&&this.onopen();break;case "close":this.fireGlobalEvent("proxyClose");this.onclose&&this.onclose();break}},callback:function(a){this.init(a.data);this.rawProxyEvent(a)}});
APE.Core=new Class({Extends:APE.Core,TCPSocket:APE.PipeProxy});
APE.PipeMulti=new Class({Extends:APE.Pipe,initialize:function(a,b){this.parent(a,b);this.type="multi";this.name=b.pipe.properties.name;if(b.users){this.users=new $H;var c=b.users}this.ape.fireEvent("multiPipeCreate",[this,b]);if(b.users){a=c.length;for(b=0;b<a;b++)this.addUser(c[b].pubid,c[b])}this.onRaw("left",this.rawLeft);this.onRaw("join",this.rawJoin)},rawJoin:function(a){this.addUser(a.data.user.pubid,a.data.user)},rawLeft:function(a,b){b.name.charAt(0)!="*"&&this.delUser(a.data.user.pubid);
a.data.user.pubid==this.ape.user.pubid&&this.ape.delPipe(b.pipe.pubid)},left:function(){this.ape.left(this.pipe.pubid)},addUser:function(a,b){var c;if(this.ape.users.has(a))c=this.ape.users.get(a);else{c=b;c.pipes=new $H;this.ape.users.set(a,b)}c.pipes.set(this.pipe.pubid,this);b={pipes:c.pipes,casttype:c.casttype,pubid:c.pubid,properties:b.properties};this.users.set(a,b);this.fireGlobalEvent("userJoin",[b,this]);return b},delUser:function(a){var b=this.users.get(a);this.users.erase(a);b.pipes.erase(this.pipe.pubid);
b.pipes.getLength()==0&&this.ape.users.erase(b.pubid);this.fireGlobalEvent("userLeft",[b,this]);return b},getUser:function(a){return this.users.get(a)},getUserPipe:function(a){if(typeof a=="string")a=this.users.get(users.pubid);return this.ape.newPipe("uni",{pipe:a})}});APE.PipeSingle=new Class({Extends:APE.Pipe,initialize:function(a,b){this.parent(a,b);this.type="uni";this.ape.fireEvent("uniPipeCreate",[this,b])}});
APE.Request=new Class({initialize:function(a){this.ape=a;this.stack=new APE.Request.Stack(a);this.cycledStack=new APE.Request.CycledStack(a);this.chl=1;this.callbackChl=new $H;if(Browser.Engine.presto){this.requestVar={updated:false,args:[]};this.requestObserver.periodical(10,this)}},send:function(a,b,c,d){if(!this.ape.requestDisabled)if(Browser.Engine.presto&&!d){this.requestVar.updated=true;this.requestVar.args.push([a,b,c])}else{d={};c||(c={});d.event=c.event||true;d.requestCallback=c.requestCallback||
null;d.callback=c.callback;a=this.ape.transport.send(this.parseCmd(a,b,d),d);$clear(this.ape.pollerObserver);this.ape.pollerObserver=this.ape.poller.delay(this.ape.options.pollTime,this.ape);return a}},parseCmd:function(a,b,c){var d=[],e={};if($type(a)=="array")for(var f,g=0;g<a.length;g++){b=a[g];e={};e.cmd=b.cmd;e.chl=this.chl++;if(!b.options)b.options={};b.params&&(e.params=b.params);f=$extend({},e.params);if(!$defined(b.options.sessid)||b.options.sessid!==false)e.sessid=this.ape.sessid;d.push(e);
var l="cmd_"+b.cmd.toLowerCase();b.options.callback&&this.callbackChl.set(e.chl,b.options.callback);if(b.options.requestCallback)c.requestCallback=b.options.requestCallback;if(c.event){if(e.params&&e.params.pipe){var j=this.ape.getPipe(e.params.pipe);if(j)f=[f,j]}this.ape.fireEvent("onCmd",[b.cmd,f]);j&&j.fireEvent(l,f);this.ape.fireEvent(l,f)}}else{e.cmd=a;e.chl=this.chl++;b&&(e.params=b);f=$extend({},b);if(!$defined(c.sessid)||c.sessid!==false)e.sessid=this.ape.sessid;d.push(e);l="cmd_"+a.toLowerCase();
c.callback&&this.callbackChl.set(e.chl,c.callback);if(c.event){if(b&&b.pipe)if(j=this.ape.getPipe(b.pipe))f=[f,j];this.ape.fireEvent("onCmd",[a,f]);j&&j.fireEvent(l,f);this.ape.fireEvent(l,f)}}var h=this.ape.options.transport;return JSON.stringify(d,function(i,k){if(typeof k=="string"){k=encodeURIComponent(k);if(h==2)k=encodeURIComponent(k)}return k})},requestObserver:function(){if(this.requestVar.updated){var a=this.requestVar.args.shift();this.requestVar.updated=this.requestVar.args.length>0?true:
false;a[3]=true;this.send.run(a,this)}}});APE.Request.Stack=new Class({initialize:function(a){this.ape=a;this.stack=[]},add:function(a,b,c){this.stack.push({cmd:a,params:b,options:c})},send:function(){this.ape.request.send(this.stack);this.stack=[]}});
APE.Request.CycledStack=new Class({initialize:function(a){this.ape=a;this.stack=[];this.reajustTime=false;this.timer=this.send.periodical(this.ape.options.cycledStackTime,this)},add:function(a,b,c){this.stack.push({cmd:a,params:b,sessid:c})},setTime:function(a,b){if(b){this.send();$clear(this.timer);this.timer=this.send.periodical(a,this);this.reajustTime=false}else this.reajustTime=a},send:function(){if(this.stack.length>0){this.ape.request.send(this.stack);this.stack=[];this.reajustTime&&this.setTime(this.reajustTime,
true)}}});Request=new Class({Extends:Request,send:function(a){if(Browser.Engine.webkit)this.xhr.onreadystatechange=this.onStateChange.bind(this);return this.parent(a)},onStateChange:function(){if(this.xhr.readyState==1)this.dataSent=true;this.parent()}});
APE.Transport.longPolling=new Class({initialize:function(a){this.ape=a;this.requestFailObserver=[]},send:function(a,b){a=(new Request({url:this.ape.serverUri,onFailure:this.ape.requestFail.bind(this.ape,[-2,this]),onComplete:function(c){$clear(this.requestFailObserver.shift());this.ape.parseResponse(c,b.requestCallback)}.bind(this)})).send(a);a.id=$time();this.request=a;this.requestFailObserver.push(this.ape.requestFail.delay(this.ape.options.pollTime+1E4,this.ape,[-1,a]));return a},running:function(){return this.request?
this.request.running:false},cancel:function(){this.request&&this.request.cancel();$clear(this.requestFailObserver.shift())}});APE.Transport.longPolling.browserSupport=function(){return Browser.Features.xhr?true:2};
APE.Request.SSE=new Class({SSESupport:typeof window.addEventStream=="function",initSSE:function(a,b,c){b=document.createElement("div");document.body.appendChild(b);b.innerHTML='<event-source src="'+this.ape.serverUri+a+"&"+$time()+'" id="APE_SSE">';this.eventSource=document.getElementById("APE_SSE");this.eventSource.addEventListener("ape-data",function(d){c.run(d.data)},false)}});
Request.XHRStreaming=new Class({Extends:Request,lastTextLength:0,read:0,send:function(a){if(Browser.Engine.webkit)this.xhr.onreadystatechange=this.onStateChange.bind(this);return this.parent(a)},onStateChange:function(){if(this.xhr.readyState==1)this.dataSent=true;else this.xhr.readyState==3&&this.progress(this.xhr.responseText,this.xhr.responseXML);this.parent()},onProgress:function(){this.fireEvent("progress",arguments)},progress:function(a,b){var c=a.length;this.read+=c;a=a.substr(this.lastTextLength);
this.lastTextLength=c;this.onProgress(this.processScripts(a),b)}});
APE.Transport.XHRStreaming=new Class({maxRequestSize:1E5,Implements:APE.Request.SSE,initialize:function(a){this.ape=a;this.requestFailObserver=[];if(this.SSESupport)this.ape.options.transport=4;this.streamInfo={timeoutObserver:null,cleanClose:false,forceClose:false,callback:null}},send:function(a,b){if(this.SSESupport&&!this.eventSource){this.initSSE(a,b,this.readSSE.bind(this));if(b.requestCallback)this.streamInfo.callback=b.requestCallback}else{if((!this.streamRequest||!this.streamRequest.running)&&
!this.eventSource){this.buffer="";this.request=this.doRequest(a,b);if(b.requestCallback)this.streamInfo.callback=b.requestCallback}else{this.request=a=(new Request({url:this.ape.serverUri,onFailure:this.ape.requestFail.bind(this.ape,[-2,this]),onComplete:function(c){$clear(this.requestFailObserver.shift());this.request.dataSent=true;this.ape.parseResponse(c,b.callback)}.bind(this)})).send(a);this.requestFailObserver.push(this.ape.requestFail.delay(this.ape.options.pollTime+1E4,this.ape,[1,a]))}return this.request}},
doRequest:function(a){this.streamInfo.forceClose=false;a=(new Request.XHRStreaming({url:this.ape.serverUri,onProgress:this.readFragment.bindWithEvent(this),onFailure:this.ape.requestFail.bind(this.ape,[-2,this]),onComplete:function(){$clear(this.streamInfo.timeoutObserver);if(this.ape.status>0){this.streamInfo.cleanClose?this.ape.check():this.newStream();this.streamInfo.cleanClose=false}}.bind(this)})).send(a);a.id=$time();return this.streamRequest=a},readSSE:function(a){this.ape.parseResponse(a,
this.streamInfo.callback);this.streamInfo.callback=null},readFragment:function(a){this.streamInfo.canClose=false;if(a==""){this.streamInfo.canClose=true;this.streamInfo.cleanClose=true;this.ape.parseResponse(a,this.streamInfo.callback);this.streamInfo.callback=null}else{a=this.buffer+a;var b=a.split("\n\n"),c=b.length;if(b.length>1){this.buffer="";for(a=0;a<c-1;a++)this.ape.parseResponse(b[a],this.streamInfo.callback);if(b[c-1]!=="")this.buffer+=b[c-1];else{this.streamInfo.canClose=true;this.checkStream()&&
this.newStream()}this.streamInfo.callback=null}else this.buffer=a}},running:function(){return this.streamRequest&&this.streamRequest.running?true:this.eventSource?true:false},checkStream:function(){return this.streamInfo.forceClose&&this.streamInfo.canClose||this.streamRequest&&this.streamRequest.read>=this.maxRequestSize&&this.streamInfo.canClose},newStream:function(){$clear(this.streamInfo.timeoutObserver);this.streamRequest.cancel();this.ape.check()},cancel:function(){this.request&&this.request.cancel();
$clear(this.streamInfo.timeoutObserver);$clear(this.requestFailObserver.shift())}});APE.Transport.XHRStreaming.browserSupport=function(){return Browser.Features.xhr&&(Browser.Engine.webkit||Browser.Engine.gecko)?true:Browser.Features.xhr?0:2};
APE.Transport.JSONP=new Class({Implements:APE.Transport.SSE,initialize:function(a){this.ape=a;this.requestFailObserver=[];this.requests=[];window.parent.onkeyup=function(b){if(b.keyCode==27){this.cancel();this.ape.status>0&&this.ape.check()}}.bind(this)},send:function(a,b){this.callback=b.requestCallback;b=document.createElement("script");b.src=this.ape.serverUri+a;document.head.appendChild(b);this.requests.push(b);this.requestFailObserver.push(this.ape.requestFail.delay(this.ape.options.pollTime+
1E4,this.ape,[-1,b]));Browser.Engine.gecko&&function(){var c=document.createElement("iframe");document.body.appendChild(c);document.body.removeChild(c)}.delay(200)},clearRequest:function(a){a.parentNode.removeChild(a);if(a.clearAttributes)a.clearAttributes();else for(var b in a)delete a[b];$clear(this.requestFailObserver.shift())},readSSE:function(a){this.ape.parseResponse(a,this.callback);this.callback=null},read:function(a){$clear(this.requestFailObserver.shift());this.clearRequest(this.requests.shift());
this.ape.parseResponse(a,this.callback);this.callback=null},cancel:function(){this.requests.length>0&&this.clearRequest(this.requests.shift())},running:function(){return this.requests.length>0?true:false}});APE.Transport.JSONP.browserSupport=function(){return true};
APE.Transport.WebSocket=new Class({stack:[],connRunning:false,initialize:function(a){this.ape=a;this.initWs()},initWs:function(){this.ws=new WebSocket((this.ape.options.secure?"wss":"ws")+"://"+this.ape.options.frequency+"."+this.ape.options.server+"/"+this.ape.options.transport+"/");this.connRunning=true;this.ws.onmessage=this.readWs.bind(this);this.ws.onopen=this.openWs.bind(this);this.ws.onclose=this.closeWs.bind(this);this.ws.onerror=this.errorWs.bind(this)},readWs:function(a){this.ape.parseResponse(a.data,
this.callback);this.callback=null},openWs:function(){if(this.stack.length>0){for(var a=0;a<this.stack.length;a++)this.send(this.stack[a].q,this.stack[a].options);this.stack.length=0}},closeWs:function(){this.connRunning=false},errorWs:function(){this.connRunning=false},send:function(a,b){if(this.ws.readyState==1){if(b.requestCallback)this.callback=b.requestCallback;this.ws.send(a)}else this.stack.push({q:a,options:b})},running:function(){return this.connRunning},cancel:function(){this.ws.close()}});
APE.Transport.WebSocket.browserSupport=function(){return"WebSocket"in window?true:1};String.implement({addSlashes:function(){return this.replace(/("|'|\\|\0)/g,"\\$1")},stripSlashes:function(){return this.replace(/\\("|'|\\|\0)/g,"$1")}});
var B64=new Hash({$p:"=",$tab:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",encode:function(a){var b=[],c=a.length,d=c%3;c=c-d;for(var e,f=0;f<c;){e=a.charCodeAt(f++)<<16|a.charCodeAt(f++)<<8|a.charCodeAt(f++);b.push(B64.$tab.charAt(e>>>18&63));b.push(B64.$tab.charAt(e>>>12&63));b.push(B64.$tab.charAt(e>>>6&63));b.push(B64.$tab.charAt(e&63))}switch(d){case 2:e=a.charCodeAt(f++)<<16|a.charCodeAt(f++)<<8;b.push(B64.$tab.charAt(e>>>18&63));b.push(B64.$tab.charAt(e>>>12&63));b.push(B64.$tab.charAt(e>>>
6&63));b.push(B64.$p);break;case 1:e=a.charCodeAt(f++)<<16;b.push(B64.$tab.charAt(e>>>18&63));b.push(B64.$tab.charAt(e>>>12&63));b.push(B64.$p);b.push(B64.$p);break}return b.join("")},decode:function(a){a=a.split("");for(var b=[],c=a.length,d=0;a[--c]==B64.$p;)++d;for(var e=0;e<c;){var f=B64.$tab.indexOf(a[e++])<<18;if(e<=c)f|=B64.$tab.indexOf(a[e++])<<12;if(e<=c)f|=B64.$tab.indexOf(a[e++])<<6;if(e<=c)f|=B64.$tab.indexOf(a[e++]);b.push(String.fromCharCode(f>>>16&255));b.push(String.fromCharCode(f>>>
8&255));b.push(String.fromCharCode(f&255))}for(;d--;)b.pop();return b.join("")}});try{window.parent.setInterval();if(!Browser.Engine.trident&&!Browser.Engine.presto&&!(Browser.Engine.gecko&&Browser.Engine.version<=18)){setInterval=function(a,b){return window.parent.setInterval(a,b)};setTimeout=function(a,b){return window.parent.setTimeout(a,b)};clearInterval=function(a){return window.parent.clearInterval(a)};clearTimeout=function(a){return window.parent.clearTimeout(a)}}}catch(e$$3){}
if(!this.JSON)this.JSON={};
(function(){function a(g){return'"'+g+'"'}function b(g,l){var j,h=d,i=l[g];if(typeof f==="function")i=f.call(l,g,i);switch(typeof i){case "string":return a(i);case "number":return isFinite(i)?String(i):"null";case "boolean":case "null":return String(i);case "object":if(!i)return"null";d+=e;g=[];if(Object.prototype.toString.apply(i)==="[object Array]"){l=i.length;for(j=0;j<l;j+=1)g[j]=b(j,i)||"null";l=g.length===0?"[]":d?"[\n"+d+g.join(",\n"+d)+"\n"+h+"]":"["+g.join(",")+"]";d=h;return l}for(j in i)if(Object.hasOwnProperty.call(i,
j))if(l=b(j,i))g.push(a(j)+(d?": ":":")+l);l=g.length===0?"{}":d?"{\n"+d+g.join(",\n"+d)+"\n"+h+"}":"{"+g.join(",")+"}";d=h;return l}}var c=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,d,e,f;if(typeof JSON.stringify!=="function"||navigator.product=="Gecko"&&function(){var g=JSON.stringify({x:1},function(l,j){return typeof j==="number"?3:j});return g.x==1?true:false})JSON.stringify=function(g,l){f=l;return b("",{"":g})};if(typeof JSON.parse!==
"function")JSON.parse=function(g,l){function j(h,i){var k,m,n=h[i];if(n&&typeof n==="object")for(k in n)if(Object.hasOwnProperty.call(n,k)){m=j(n,k);if(m!==undefined)n[k]=m;else delete n[k]}return l.call(h,i,n)}c.lastIndex=0;if(c.test(g))g=g.replace(c,function(h){return"\\u"+("0000"+h.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(g.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,
""))){g=eval("("+g+")");return typeof l==="function"?j({"":g},""):g}throw new SyntaxError("JSON.parse");}})();
APE.Core=new Class({Extends:APE.Core,initialize:function(a){if(this.getInstance(a.identifier).instance)a.restore=true;this.parent(a);a.restore&&this.init();this.addEvent("uniPipeCreate",this.saveSessionPipe);this.addEvent("uniPipeDelete",this.saveSessionPipe)},saveSessionPipe:function(){var a=[];this.pipes.each(function(b){b.type=="uni"&&a.push({casttype:b.type,pubid:b.pipe.pubid,properties:b.properties})});this.setSession({uniPipe:JSON.stringify(a)})},restoreUniPipe:function(a){if(a=JSON.parse(decodeURIComponent(a.data.sessions.uniPipe)))for(var b=
0;b<a.length;b++)this.newPipe("uni",{pipe:a[b]});this.fireEvent("restoreEnd");this.restoring=false},init:function(){this.initCookie();this.createCookie();this.saveCookie()},restoreCallback:function(a){if(a.raw!="ERR"&&this.status==0){this.fireEvent("init");this.fireEvent("ready");this.status=1}else this.status==0&&this.stopPoller()},connect:function(a,b){var c=this.initCookie();if(c){b||(b={});if(!b.request)b.request="stack";b.requestCallback=this.restoreCallback.bind(this);this.restoring=true;this.fireEvent("restoreStart");
this.startPoller();this.getSession("uniPipe",this.restoreUniPipe.bind(this),b)}else{this.addEvent("init",this.init);this.parent(a,b)}},getInstance:function(a){var b=Cookie.read("APE_Cookie",{domain:document.domain});a=a||this.options.identifier;if(!b)return false;b=JSON.parse(b);if(!b||!b.instance)return false;for(var c=0;c<b.instance.length;c++)if(b.instance[c]&&b.instance[c].identifier==a)return{instance:b.instance[c],cookie:b};return{cookie:b}},removeInstance:function(a){if(this.cookie)for(var b=
0;b<this.cookie.instance.length;b++)if(this.cookie.instance[b].identifier==a){this.cookie.instance.splice(b,1);return}},initCookie:function(){var a=this.getInstance();if(a&&a.instance){this.sessid=a.instance.sessid;this.pubid=a.instance.pubid;a.cookie.frequency=a.cookie.frequency.toInt()+1;this.cookie=a.cookie;return true}else{if(a.cookie){this.createInstance(a.cookie);a.cookie.frequency=a.cookie.frequency.toInt()+1;this.cookie=a.cookie}else this.cookie=null;return false}},createInstance:function(a){a.instance.push({identifier:this.options.identifier,
pubid:this.getPubid(),sessid:this.getSessid()})},createCookie:function(){if(!this.cookie){var a={frequency:1,instance:[]};this.createInstance(a);this.cookie=a}},saveCookie:function(){Cookie.write("APE_Cookie",JSON.stringify(this.cookie),{domain:document.domain})},clearSession:function(){this.parent();this.removeInstance(this.options.identifier);this.saveCookie()},removeCookie:function(){Cookie.dispose("APE_Cookie",{domain:this.options.domain})}});
